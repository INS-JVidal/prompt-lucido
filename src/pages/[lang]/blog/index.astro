---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import { t, type Lang } from '../../../i18n/utils';
import { ui } from '../../../i18n/ui';

export function getStaticPaths() {
	return Object.keys(ui).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params as { lang: Lang };

const posts = (await getCollection('blog', ({ data }) => (import.meta.env.PROD ? !data.draft : true) && data.lang === lang))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Extract unique series names from published posts
const seriesSet = new Set<string>();
posts.forEach((p) => {
	if (p.data.series) seriesSet.add(p.data.series);
});
const seriesList = Array.from(seriesSet).sort();
---

<BaseLayout title={`${t('blog.title', lang)} â€” ${t('site.title', lang)}`} lang={lang}>
	<section class="blog-list container--narrow">
		<h1 class="blog-list__title">{t('blog.title', lang)}</h1>

		{seriesList.length > 0 && (
			<div class="blog-filters" role="group" aria-label="Filter by series">
				<button class="blog-filter active" data-filter="">{t('blog.filterAll', lang)}</button>
				{seriesList.map((s) => (
					<button class="blog-filter" data-filter={s}>{s}</button>
				))}
			</div>
		)}

		<div class="blog-list__entries">
			{posts.length > 0 ? (
				posts.map((post) => {
					const slug = post.id.replace(/^(es|en)\//, '');
					return (
						<PostCard
							title={post.data.title}
							description={post.data.description}
							pubDate={post.data.pubDate}
							href={`/${lang}/blog/${slug}`}
							series={post.data.series}
							readingTime={post.data.readingTime}
							lang={lang}
						/>
					);
				})
			) : (
				<p class="blog-list__empty">{t('blog.empty', lang)}</p>
			)}
		</div>
	</section>
</BaseLayout>

<style>
	.blog-list {
		padding: 3rem 0 4rem;
	}

	.blog-list__title {
		font-family: var(--font-heading);
		font-size: 2.25rem;
		font-weight: 700;
		letter-spacing: -0.02em;
		margin-bottom: 1.5rem;
	}

	/* --- Filter pills --- */

	.blog-filters {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-bottom: 2rem;
	}

	.blog-filter {
		font-family: var(--font-ui);
		font-size: 0.8rem;
		font-weight: 500;
		padding: 0.35rem 0.85rem;
		border-radius: 20px;
		border: 1px solid var(--border);
		background: transparent;
		color: var(--text-secondary);
		cursor: pointer;
		transition: background 0.15s, color 0.15s, border-color 0.15s;
	}

	.blog-filter:hover {
		border-color: var(--text-muted);
		color: var(--text);
	}

	.blog-filter.active {
		color: var(--accent);
		background: var(--accent-light);
		border-color: var(--accent);
	}

	/* --- Entries --- */

	.blog-list__entries {
		display: flex;
		flex-direction: column;
	}

	.blog-list__empty {
		font-family: var(--font-body);
		color: var(--text-muted);
		font-size: 1.1rem;
	}

	@media (max-width: 768px) {
		.blog-list {
			padding: 2rem 0 3rem;
		}

		.blog-list__title {
			font-size: 1.75rem;
		}
	}
</style>

<script>
	function initFilters() {
		const buttons = document.querySelectorAll<HTMLButtonElement>('.blog-filter');
		const entries = document.querySelectorAll<HTMLElement>('.post-entry');
		if (buttons.length === 0) return;

		buttons.forEach((btn) => {
			btn.addEventListener('click', () => {
				const filter = btn.dataset.filter ?? '';

				// Update active button
				buttons.forEach((b) => b.classList.remove('active'));
				btn.classList.add('active');

				// Filter entries
				entries.forEach((entry) => {
					const series = entry.dataset.series ?? '';
					if (filter === '' || series === filter) {
						entry.style.display = '';
					} else {
						entry.style.display = 'none';
					}
				});
			});
		});
	}

	initFilters();
	document.addEventListener('astro:after-swap', initFilters);
</script>
