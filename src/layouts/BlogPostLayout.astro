---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { t, type Lang } from '../i18n/utils';

interface Heading {
	depth: number;
	slug: string;
	text: string;
}

interface Props {
	title: string;
	description: string;
	pubDate: Date;
	updatedDate?: Date;
	tags?: string[];
	category?: string;
	readingTime?: number;
	lang?: string;
	image?: { src: string; mobileSrc?: string; alt: string };
	translationUrl?: string;
	headings?: Heading[];
}

const {
	title,
	description,
	pubDate,
	updatedDate,
	tags = [],
	category,
	readingTime,
	lang = 'es',
	image,
	translationUrl,
	headings = [],
} = Astro.props;

const formattedDate = pubDate.toLocaleDateString(lang, {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
});

const formattedUpdate = updatedDate?.toLocaleDateString(lang, {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
});

const hasH2 = headings.some((h) => h.depth === 2);
---

<BaseLayout title={`${title} — Prompt Lúcido`} description={description} lang={lang} translationUrl={translationUrl}>
	<div class:list={['post-wrapper', hasH2 && 'post-wrapper--with-toc']}>
		{image ? (
			<div class="post-hero">
				<picture>
					{image.mobileSrc && (
						<source media="(max-width: 768px)" srcset={image.mobileSrc} />
					)}
					<img src={image.src} alt={image.alt} />
				</picture>
				<header class="post-hero__header">
					{category && <span class="tag">{category}</span>}
					<h1 class="post__title">{title}</h1>
					<p class="post__meta">
						<time datetime={pubDate.toISOString()}>{formattedDate}</time>
						{readingTime && <span>&middot; {readingTime} {t('post.readingTime', lang as Lang)}</span>}
					</p>
					{updatedDate && (
						<p class="post__updated">{t('post.updated', lang as Lang)} {formattedUpdate}</p>
					)}
				</header>
			</div>
		) : (
			<header class="post__header">
				{category && <span class="tag">{category}</span>}
				<h1 class="post__title">{title}</h1>
				<p class="post__meta">
					<time datetime={pubDate.toISOString()}>{formattedDate}</time>
					{readingTime && <span>&middot; {readingTime} {t('post.readingTime', lang as Lang)}</span>}
				</p>
				{updatedDate && (
					<p class="post__updated">{t('post.updated', lang as Lang)} {formattedUpdate}</p>
				)}
			</header>
		)}

		{hasH2 && (
			<div class="post__toc-mobile">
				<TableOfContents headings={headings} lang={lang} variant="mobile" />
			</div>
		)}

		<article class:list={['post', hasH2 ? 'post--with-toc' : 'container--narrow']}>
			<div class="post__body">
				<div class="prose">
					<slot />
				</div>

				{tags.length > 0 && (
					<footer class="post__tags">
						{tags.map((t) => (
							<span class="tag">{t}</span>
						))}
					</footer>
				)}
			</div>

			{hasH2 && (
				<aside class="post__toc-sidebar">
					<TableOfContents headings={headings} lang={lang} variant="sidebar" />
				</aside>
			)}
		</article>
	</div>
</BaseLayout>

<style>
	/* --- Wrapper: contains hero, mobile TOC, and article --- */

	.post-wrapper {
		max-width: var(--content-width);
		margin: 0 auto;
		padding: 0 var(--gap);
	}

	.post-wrapper--with-toc {
		max-width: calc(var(--page-width) + 200px + 3rem);
	}

	/* --- Mobile TOC: sticky below header --- */

	.post__toc-mobile {
		position: sticky;
		top: 3.5rem;
		z-index: 50;
		background: var(--bg);
	}

	@media (min-width: 900px) {
		.post__toc-mobile {
			display: none;
		}
	}

	/* --- Article: two-column layout with TOC --- */

	.post {
		padding-top: 0;
		padding-bottom: 4rem;
	}

	.post--with-toc {
		display: flex;
		align-items: stretch;
		gap: 0 3rem;
	}

	.post__body {
		flex: 1;
		min-width: 0;
	}

	.post__toc-sidebar {
		display: none;
	}

	@media (min-width: 900px) {
		.post__toc-sidebar {
			display: block;
			flex: 0 0 200px;
			position: relative;
		}
	}

	/* --- Hero: image + overlaid header (CSS Grid stack) --- */

	.post-hero {
		display: grid;
		border-radius: 12px;
		overflow: hidden;
		margin-bottom: 2.5rem;
	}

	.post-hero > picture,
	.post-hero::after,
	.post-hero__header {
		grid-column: 1;
		grid-row: 1;
	}

	.post-hero > picture {
		min-height: 175px;
		max-height: 280px;
	}

	.post-hero img {
		display: block;
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.post-hero::after {
		content: '';
		align-self: end;
		height: 70%;
		background: linear-gradient(to bottom, transparent 0%, #FAF9F6 100%);
		pointer-events: none;
		z-index: 1;
	}

	.post-hero__header {
		align-self: end;
		padding: 2rem;
		z-index: 2;
	}

	/* --- Fallback header (no image) --- */

	.post__header {
		margin-bottom: 2.5rem;
		padding-bottom: 2rem;
		border-bottom: 1px solid var(--border);
	}

	/* --- Shared text styles --- */

	.post__title {
		font-family: var(--font-heading);
		font-size: clamp(2.3rem, 5vw, 3.15rem);
		font-weight: 700;
		line-height: 1.15;
		letter-spacing: -0.02em;
		margin-top: 0.75rem;
		color: var(--text);
	}

	.post__meta {
		font-family: var(--font-ui);
		font-size: 0.95rem;
		color: var(--text-muted);
		margin-top: 1rem;
		display: flex;
		gap: 0.5rem;
		align-items: center;
	}

	.post__updated {
		font-family: var(--font-ui);
		font-size: 0.875rem;
		color: var(--text-muted);
		margin-top: 0.25rem;
		font-style: italic;
	}

	.post__tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 1px solid var(--border);
	}

	@media (max-width: 768px) {
		.post {
			padding-bottom: 3rem;
		}

		.post-hero > picture {
			min-height: 125px;
			max-height: 200px;
		}

		.post-hero__header {
			padding: 1.25rem;
		}

		.post__header {
			margin-bottom: 1.75rem;
		}
	}
</style>
